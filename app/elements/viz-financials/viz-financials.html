<link rel="import" href="../../../bower_components/polymer/polymer.html">

<polymer-element name="viz-financials" attributes="customers">
  <template>
    <link rel="stylesheet" href="../../bower_components/chartist/dist/chartist.min.css">
    <link rel="stylesheet" href="viz-financials.css">

    <core-localstorage
      name="accounts-opened"
      value="{{ accountsOpened }}"></core-localstorage>

    <div id="pieChart" class="ct-chart ct-perfect-fourth">
      <h2 class="chart-title">Value Creation this month</h2>
    </div>

    <ul class="accounts-list">
      <template repeat="{{ c, i in customers }}">
        <li>
          <summary-view name="{{ c.name }}" data="{{ c.summary }}" titleSize="large"></summary-view>
          <project-collapse projects="{{ c.projects }}"></project-collapse>
        </li>
      </template>
    </ul>
  </template>
  <script src="../../bower_components/chartist/dist/chartist.js"></script>
  <script>
    /* jshint camelcase: false */
    /* global Chartist */
    (function () {
      Polymer({
        accountsOpened: [],

        customersChanged: function(oldValue, newValue) {
          if (newValue) {

            // sort customers
            var sorted = newValue.sort(function(a, b) {
              return a.summary.value_creation_this_month < b.summary.value_creation_this_month;
            });

            // sort projects within customers
            sorted.forEach(function(c) {
              c.projects.sort(function(a, b) {
                return a.value_creation_this_month < b.value_creation_this_month;
              });
            });

            this.customers = sorted;
            this.drawChart(sorted);
          }
        },

        /**
         * Draws a graph using the Chartist library
         */
        drawChart: function(customers) {
          var chartEl = this.$.pieChart;

          var labels = customers.map(function(c) {
            return c.name;
          });

          var series = customers.map(function(c) {
            return c.summary.value_creation_this_month;
          });

          var data = {
            labels: labels,
            series: series
          };

          var opts = {
            donut: true,
            donutWidth: 10,
            chartPadding: 65,
            labelOffset: 25,
            labelDirection: 'explode',
            // labelInterpolationFnc: function(value) {
            //   return value;
            // }
          };

          new Chartist.Pie(chartEl, data, opts);
        }
      });
    })();
  </script>
</polymer-element>

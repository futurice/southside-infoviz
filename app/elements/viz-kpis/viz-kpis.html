<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/polymer/polymer.html">

<dom-module id="viz-kpis">

  <link rel="stylesheet" href="viz-kpis.css">

  <template>
    <div class="kpi-numbers" class="layout horizontal">
      <div class="flex" title="Estimated future revenue.">
        <span class="number">{{computeValue('orderbook')}}</span>
        <span class="description">Orderbook</span>
      </div>
      <div class="flex" title="Estimated revenue for this month.">
        <span class="number">{{computeValue('valuecreation')}}</span>
        <span class="description">Value Creation this month</span>
      </div>
      <div class="flex" title="Estimated profit divided by revenue">
        <span class="number">{{computeValue('ebit')}}</span>
        <span class="description">EBIT (month)</span>
      </div>
      <div class="flex" title="Number of persons working for tribe this month, converted to full time employees.">
        <span class="number">{{computeValue('fte')}}</span>
        <span class="description">FTE</span>
      </div>
      <div class="flex" title="Number of persons on bench this month, converted to full time employees.">
        <span class="number">{{format(bench_percent, 1, '%')}}</span>
        <span class="description">Bench</span>
      </div>
    </div>
  </template>
  <script>
    (function () {
      var matchName = function(obj, name) {
        return obj.name && obj.name.toLowerCase() === name;
      };

      Polymer({
        is: 'viz-kpis',

        properties: {
          summary: {
            type: Object
          },
          customers: {
            type: Array,
            observer: 'customersChanged'
          }
        },
        computeValue: function(propName) {
          switch (propName) {
            case 'orderbook':
              return this.format(
                  summary.orderbook / 1000,
                  0, 'k€'
                );
            case 'valuecreation':
              return this.format(
                  summary.value_creation_this_month / 1000,
                  0, 'k€'
                );
            case 'ebit':
              return this.format(
                  summary.ebit_margin_this_month * 100,
                  1, '%'
                );
            case 'fte':
              return this.format(
                  summary.fte_this_month,
                  1
                );
            default:
              return '';
          }
        },
        format: function(value, precision, unit) {
          if (!Number(value)) {
            return '-';
          }
          var result = Number(value).toFixed(precision);
          if (unit) {
            result += ' '+unit;
          }
          return result;
        },
        customersChanged: function(newVal, oldVal) {
          var self = this;
          if (!newVal) {
            return;
          }
          newVal
            .filter(function(item) {
              return matchName(item, 'futurice');
            })
            .forEach(function(customer) {
              customer.projects
                .filter(function(project) {
                  return matchName(project, 'bench');
                })
                .forEach(function(project) {
                  var b = project.fte_this_month;
                  self.bench_fte = b;
                  self.bench_percent =
                    100 * b / Number(self.summary.fte_this_month);
                });
            });
        }
      });
    })();
  </script>
</dom-module> <!-- CONVERTED -->


<!-- CONVERSION NOTES TODO:
 Review code and look for: 
 - textContent binding from <div>First: {{first}}</div> TO First <span>{{first}}</span><br>
 - polymer-element default attributes such as tabindex="0" move to hostAttributes: {  tabindex: 0}
 - custom elements correct JSON quotes required, change from <my-element foo="{ 'title': 'Persuasion', 'author': 'Austen' }"> to </my-element> to <my-element foo="{ "title": "Persuasion", "author": "Austen" }"></my-element>
 - custom elements attribute use dash-case not camelCase, change from  <my-element fooBar= to <my-element foo-bar
 - Polymer( fix mixins use Behaviors after is: see  ,
 - Layout attributes replaced by layout classes <div layout horizontal center>` to `<div class="layout horizontal center">, 
 - Convert core- to iron- or paper- replacement elements at PolymerElements
 - fix indentation as need 
 - Cleanup Comments to reflect changes ,
 - see https://www.polymer-project.org/0.9/docs/migration.html
   -->
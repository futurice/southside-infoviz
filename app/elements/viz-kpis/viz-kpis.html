<link rel="import" href="../../../bower_components/polymer/polymer.html">

<polymer-element name="viz-kpis" attributes="summary customers">
  <template>
    <link rel="stylesheet" href="viz-kpis.css">
    <div class="kpi-numbers" layout horizontal>
      <div flex title="Estimated future revenue.">
        <span class="number">{{ summary.orderbook / 1000 | format(0, 'k€') }}</span>
        <span class="description">Orderbook</span>
      </div>
      <div flex title="Estimated revenue for this month.">
        <span class="number">{{ summary.value_creation_this_month / 1000 | format(0, 'k€') }}</span>
        <span class="description">Value Creation this month</span>
      </div>
      <div flex title="Estimated profit divided by revenue">
        <span class="number {{ { 'highlight-negative': summary.ebit_margin_this_month < 0.05,'highlight-positive': summary.ebit_margin_this_month >= 0.15 } | tokenList }}">
          {{ summary.ebit_margin_this_month*100 | format(1, '%') }}
        </span>
        <span class="description">EBIT (month)</span>
      </div>
      <div flex title="Number of persons working for tribe this month, converted to full time employees.">
        <span class="number">{{ summary.fte_this_month | format(1) }}</span>
        <span class="description">FTE</span>
      </div>
      <div flex title="Number of persons on bench this month, converted to full time employees.">
        <span class="number">{{ bench_percent | format(1, '%') }}</span>
        <span class="description">Bench</span>
      </div>
    </div>
  </template>
  <script>
    (function () {
      var matchName = function(obj, name) {
        return obj.name && obj.name.toLowerCase() === name;
      };

      Polymer({
        format: function(value, precision, unit) {
          if (!Number(value)) {
            return '-';
          }
          var result = Number(value).toFixed(precision);
          if (unit) {
            result += ' '+unit;
          }
          return result;
        },
        customersChanged: function(oldVal, newVal) {
          var self = this;
          if (!newVal) {
            return;
          }
          newVal
            .filter(function(item) {
              return matchName(item, 'futurice');
            })
            .forEach(function(customer) {
              customer.projects
                .filter(function(project) {
                  return matchName(project, 'bench');
                })
                .forEach(function(project) {
                  var b = project.fte_this_month;
                  self.bench_fte = b;
                  self.bench_percent =
                    100 * b / Number(self.summary.fte_this_month);
                });
            });
        }
      });
    })();
  </script>
</polymer-element>
